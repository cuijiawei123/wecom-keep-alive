# 功能规格说明：macOS 托盘应用重构

**功能分支**: `001-tray-app-refactor`
**创建日期**: 2026-01-04
**状态**: 草稿
**输入**: 将 WeComKeepAlive 重新架构为基于 Electron 的 macOS 原生风格任务栏应用（Tray App）

## 用户场景与测试 *(必填)*

### 用户故事 1 - 托盘模式启动与基本控制 (优先级: P1)

作为一名需要保持企业微信在线状态的用户，我希望应用启动后仅在 macOS 右上角菜单栏显示图标，不占用 Dock 位置，并通过点击图标快速控制应用的开始/停止状态。

**优先级理由**: 这是应用的核心交互入口，没有托盘功能，其他所有功能都无法使用。

**独立测试**: 可通过启动应用、验证 Dock 无图标、点击托盘图标验证菜单弹出来完成测试。

**验收场景**:

1. **Given** 应用未运行, **When** 用户启动应用, **Then** 应用图标仅出现在右上角菜单栏，Dock 中不显示图标
2. **Given** 应用正在运行, **When** 用户点击托盘图标, **Then** 弹出菜单显示"开始/停止"、"打开主界面"、"退出"选项
3. **Given** 保活功能已停止, **When** 用户点击"开始", **Then** 保活功能启动，托盘图标状态变化以指示运行中
4. **Given** 保活功能运行中, **When** 用户点击"停止", **Then** 保活功能停止，托盘图标状态变化以指示已停止

---

### 用户故事 2 - 鼠标微移动保活 (优先级: P1)

作为用户，我希望应用能在后台自动进行微小的鼠标移动（1像素），以防止系统判定我为"离开"状态，且移动间隔随机（30-90秒）以模拟真实行为。

**优先级理由**: 这是应用的核心价值功能，直接解决用户的痛点问题。

**独立测试**: 可通过启动保活功能、观察鼠标是否在指定时间间隔内发生微移动来验证。

**验收场景**:

1. **Given** 保活功能已启动, **When** 经过 30-90 秒随机间隔, **Then** 鼠标位置发生 1 像素的微移动
2. **Given** 保活功能运行中, **When** 用户正在操作鼠标, **Then** 微移动不会干扰用户的正常操作
3. **Given** 保活功能已停止, **When** 等待任意时间, **Then** 不会发生任何鼠标移动

---

### 用户故事 3 - 主控制面板 (优先级: P2)

作为用户，我希望通过一个简洁的主界面来配置保活功能，包括开关切换、工作时段设置、工作日模式，并能看到距离下次活跃的倒计时。

**优先级理由**: 提供可视化配置界面，提升用户体验，但不影响核心功能运行。

**独立测试**: 可通过打开主界面、操作各配置项、验证配置生效来完成测试。

**验收场景**:

1. **Given** 用户点击托盘菜单"打开主界面", **When** 界面打开, **Then** 显示精美的 Toggle 开关、时段设置、状态信息
2. **Given** 主界面已打开, **When** 用户切换 Toggle 开关, **Then** 保活功能相应启动或停止
3. **Given** 保活功能运行中, **When** 用户查看主界面, **Then** 显示"距离下次活跃还有 XX 秒"的倒计时
4. **Given** 用户设置工作时段为 09:00-18:30, **When** 当前时间在此范围外, **Then** 保活功能自动暂停
5. **Given** 用户启用工作日模式, **When** 当前是周末, **Then** 保活功能自动暂停

---

### 用户故事 4 - macOS 辅助功能权限处理 (优先级: P2)

作为用户，我希望应用在首次启动时检测辅助功能权限，如果没有权限则引导我去系统设置开启，避免功能无法正常工作。

**优先级理由**: 权限是鼠标控制功能的前提，但属于一次性设置，优先级略低于核心功能。

**独立测试**: 可通过在无权限状态下启动应用、验证引导弹窗出现来完成测试。

**验收场景**:

1. **Given** 应用未获得辅助功能权限, **When** 应用启动, **Then** 弹出提示窗口说明需要权限并提供跳转到系统设置的按钮
2. **Given** 用户点击跳转按钮, **When** 系统设置打开, **Then** 自动定位到辅助功能权限页面
3. **Given** 应用已获得辅助功能权限, **When** 应用启动, **Then** 不显示权限提示，直接进入正常运行状态

---

### 用户故事 5 - 深浅色模式适配 (优先级: P3)

作为 macOS 用户，我希望托盘图标能自动适配系统的深色/浅色模式，保持视觉一致性。

**优先级理由**: 属于体验优化，不影响核心功能。

**独立测试**: 可通过切换系统外观模式、观察托盘图标是否正确适配来验证。

**验收场景**:

1. **Given** 系统处于浅色模式, **When** 查看托盘图标, **Then** 图标以深色显示，清晰可见
2. **Given** 系统处于深色模式, **When** 查看托盘图标, **Then** 图标以浅色显示，清晰可见
3. **Given** 应用运行中, **When** 用户切换系统外观模式, **Then** 托盘图标自动切换为适配的颜色

---

### 边缘情况

- 用户在保活运行期间关闭笔记本盖子（系统休眠）后重新打开，应用应恢复正常运行
- 用户在工作时段边界时刻（如 18:30）操作，应用应正确处理时段切换
- 系统时间被手动修改时，工作时段判断应基于新时间
- 多显示器环境下鼠标微移动应在当前活跃屏幕进行
- 用户撤销辅助功能权限后，应用应检测到并重新提示

## 需求 *(必填)*

### 功能需求

- **FR-001**: 应用 MUST 以托盘模式运行，启动后仅在 macOS 右上角菜单栏显示图标
- **FR-002**: 应用 MUST 不在 Dock 中显示图标（LSUIElement 模式）
- **FR-003**: 托盘图标 MUST 支持点击弹出菜单，包含"开始/停止"、"打开主界面"、"退出"选项
- **FR-004**: 应用 MUST 能够模拟鼠标微移动（1 像素），间隔为 30-90 秒随机
- **FR-005**: 应用 MUST 在启动时检测 macOS 辅助功能权限，无权限时引导用户开启
- **FR-006**: 主界面 MUST 提供 Toggle 开关控制保活功能的启停
- **FR-007**: 应用 MUST 支持设置工作时段（开始时间和结束时间）
- **FR-008**: 应用 MUST 支持工作日模式（仅周一至周五生效）
- **FR-009**: 主界面 MUST 显示"距离下次活跃还有 XX 秒"的倒计时
- **FR-010**: 托盘图标 MUST 使用 Template Image 支持深浅色模式自动适配
- **FR-011**: 应用 MUST 持久化用户配置（开关状态、工作时段、工作日模式）
- **FR-012**: 托盘图标 MUST 通过视觉状态区分"运行中"和"已停止"状态

### 关键实体

- **用户配置**: 保活开关状态、工作时段（开始时间、结束时间）、工作日模式开关、上次修改时间
- **运行状态**: 当前是否活跃、下次活跃倒计时、权限状态

## 成功标准 *(必填)*

### 可衡量结果

- **SC-001**: 应用启动到托盘图标显示的时间不超过 3 秒
- **SC-002**: 应用空闲时内存占用低于 100MB
- **SC-003**: 应用空闲时 CPU 占用接近 0%（低于 1%）
- **SC-004**: 鼠标微移动对用户正常操作无感知干扰
- **SC-005**: 用户能在 30 秒内完成首次配置（工作时段+工作日模式）
- **SC-006**: 权限引导流程用户一次操作即可完成授权
- **SC-007**: 深浅色模式切换后托盘图标在 1 秒内完成适配

## 假设

- 目标用户使用 macOS 系统（Intel 或 Apple Silicon）
- 用户愿意授予辅助功能权限以实现鼠标控制
- 工作时段默认为 09:00-18:30，工作日模式默认关闭
- 鼠标移动间隔 30-90 秒足以保持在线状态
- 用户配置存储在本地，无需云同步
